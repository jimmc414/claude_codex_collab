name: Final Review and Merge Readiness

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request number to review'
        required: true
        type: number

jobs:
  final-validation:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml markdown pytest

      - name: Verify All Documents Present
        run: |
          required_files=("docs/requirements.md" "docs/architecture.md" "docs/implementation.md")
          missing_files=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
            fi
          done
          if [ ${#missing_files[@]} -gt 0 ]; then
            echo "Missing required documents: ${missing_files[*]}"
            exit 1
          fi

      - name: Generate Traceability Matrix
        run: |
          python .github/review-scripts/traceability_matrix.py \
            docs/requirements.md \
            docs/architecture.md \
            docs/implementation.md \
            src/ > traceability_matrix.md

      - name: Run All Tests
        run: |
          if [ -f "pytest.ini" ] || [ -f "setup.cfg" ] || [ -f "pyproject.toml" ]; then
            pytest --tb=short --junit-xml=test_results.xml || true
          fi
          if [ -f "package.json" ] && grep -q "\"test\"" package.json; then
            npm test || true
          fi

      - name: Check Requirements Coverage
        run: |
          python .github/review-scripts/requirements_verification.py \
            docs/requirements.md \
            src/ \
            test_results.xml > requirements_coverage.json

      - name: Validate Documentation Completeness
        run: |
          python .github/review-scripts/documentation_checker.py \
            docs/ \
            src/ > documentation_report.json

      - name: Performance Benchmark
        run: |
          if [ -f "benchmark.py" ]; then
            python benchmark.py > benchmark_results.json || true
          fi

      - name: Calculate Quality Score
        id: quality
        run: |
          python .github/review-scripts/quality_scorer.py \
            requirements_coverage.json \
            documentation_report.json \
            test_results.xml > quality_score.json

          score=$(jq -r '.total_score' quality_score.json)
          echo "quality_score=$score" >> $GITHUB_OUTPUT

      - name: Generate Final Report
        run: |
          python .github/review-scripts/final_report_generator.py \
            quality_score.json \
            traceability_matrix.md \
            requirements_coverage.json \
            documentation_report.json > final_report.md

      - name: Post Final Review
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const fs = require('fs');
            const finalReport = fs.readFileSync('final_report.md', 'utf8');
            const qualityScore = JSON.parse(fs.readFileSync('quality_score.json', 'utf8'));

            const prNumber = context.payload.pull_request?.number || context.payload.inputs?.pr_number;

            let comment = '# ðŸŽ¯ Final Review Report\n\n';
            comment += `## Overall Quality Score: ${qualityScore.total_score}/100\n\n`;

            // Add status badges
            const badges = [];
            if (qualityScore.requirements_coverage >= 90) badges.push('âœ… Requirements');
            if (qualityScore.test_coverage >= 80) badges.push('âœ… Tests');
            if (qualityScore.documentation_score >= 85) badges.push('âœ… Documentation');
            if (qualityScore.code_quality >= 85) badges.push('âœ… Code Quality');

            comment += badges.join(' | ') + '\n\n';

            // Add detailed report
            comment += finalReport;

            // Add traceability matrix as collapsible section
            if (fs.existsSync('traceability_matrix.md')) {
              const matrix = fs.readFileSync('traceability_matrix.md', 'utf8');
              comment += '\n<details>\n<summary>ðŸ“Š Traceability Matrix</summary>\n\n';
              comment += matrix;
              comment += '\n</details>\n';
            }

            // Approval recommendation
            const approved = qualityScore.total_score >= 85;
            if (approved) {
              comment += '\n## âœ… Recommendation: APPROVED FOR MERGE\n';
              comment += 'All quality criteria have been met.\n';
            } else {
              comment += '\n## âš ï¸ Recommendation: NEEDS IMPROVEMENT\n';
              comment += 'Please address the following before merging:\n';
              qualityScore.improvements.forEach(item => {
                comment += `- ${item}\n`;
              });
            }

            // Post comment
            if (prNumber) {
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });

              // Add label based on status
              const label = approved ? 'ready-to-merge' : 'needs-work';
              await github.rest.issues.addLabels({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: [label]
              });
            }

            // Set job status
            if (!approved) {
              core.setFailed(`Quality score ${qualityScore.total_score} is below threshold of 85`);
            }

      - name: Auto-approve if passing
        if: success() && steps.quality.outputs.quality_score >= 90
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const prNumber = context.payload.pull_request?.number;
            if (prNumber) {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                event: 'APPROVE',
                body: 'ðŸ¤– Auto-approved: All quality criteria exceeded expectations.'
              });
            }

      - name: Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: review-reports
          path: |
            final_report.md
            traceability_matrix.md
            quality_score.json
            requirements_coverage.json
            documentation_report.json